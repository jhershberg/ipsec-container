set -x

source ./vars

rm -rf left right
mkdir left
mkdir right

pwd=$(pwgen -s 64 1) 
echo $left_ip $right_ip : PSK \"$pwd\" > left/ipsec.secrets
echo $left_ip $right_ip : PSK \"$pwd\" > right/ipsec.secrets

cat <<EOF | 
# /etc/ipsec.conf - Libreswan IPsec configuration file
#
# Manual:     ipsec.conf.5

config setup
	virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:25.0.0.0/8,%v4:100.64.0.0/10,%v6:fd00::/8,%v6:fe80::/10
	protostack=netkey

conn mytunnel
    auto=add
    nat-ikev1-method=none
    authby=secret
    left=$left_ip
    right=$right_ip
    leftsubnet=0.0.0.0/0
    rightsubnet=0.0.0.0/0
    mark=5/0xffffffff
    vti-interface=vti01
    vti-routing=no
EOF
tee left/ipsec.conf right/ipsec.conf

sudo docker build . -t tun

if [ "$(sudo docker network list | grep 'vpn-network')" = "" ]
then
    sudo docker network create --subnet=$network_range --ip-range=$network_pool --gateway=$network_gw vpn-network
fi
